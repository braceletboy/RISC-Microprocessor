-- Takes in fsm_write signal
-- If fsm_write = '1', then load a value into new state based on the value present in IR_a

library ieee;
use ieee.std_logic_1164.all;
use ieee.std_logic_unsigned.all;

library std;
use std.standard.all;

entity FSM is
	port(CLK, fsm_flush, fsm_write: in std_logic; IR_a: in std_logic_vector(15 downto 0); state: out std_logic_vector(1 downto 0));
end entity;

architecture fsm_arch of FSM is
	type fsm_state is (s0, s1, s2, s3); --s0 = 11, s1=01, s2=10, s3=00
	signal fsmstate: fsm_state := s3;
begin
	process(CLK)
	begin
		if fsm_flush = '1' then
			fsmstate <= s3;
		else
			if fsm_write = '1' then --fsm_write = 1 (default value for fsm_write)
				if (rising_edge(CLK) and IR_a(15 downto 12) = "0100") then
					fsmstate <= s0;
				elsif (rising_edge(CLK) and IR_a(15 downto 14) = "00") then
					fsmstate <= s2;
				end if;
			else
				if rising_edge(CLK) then
					if fsmstate = s0 then
						fsmstate <= s1;
					elsif fsmstate = s1 then
						fsmstate <= s3;
					elsif fsmstate = s2 then
						fsmstate <= s1;
					else
						fsmstate <= s3;
					end if;
				end if;
			end if;
		end if;
	end process;
	
	process(fsmstate)
	begin
		if fsmstate=s0 then
			state <= "11";
		elsif fsmstate=s1 then
			state <= "01";
		elsif fsmstate=s2 then
			state <= "10";
		else
			state <= "00";
		end if;
	end process;
end fsm_arch;

